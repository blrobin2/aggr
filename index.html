<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aggr</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        <h3>Aggr: Music Score Aggregation</h3>
        <div id="albums"></div>
      </div>
    </div>
  </div>

  <script id="albums-template" type="text/x-handlebars-template">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Artist</th>
          <th>Album</th>
        </tr>
      </thead>
      <tbody>
        {{#each albums}}
          <tr>
            <td>{{date}}</td>
            <td>{{artist}}</td>
            <td>{{album}}</td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
  <script src="https://cdn.jsdelivr.net/lodash/4.17.3/lodash.min.js"></script>
  <script>
    const albumsSrc = document.getElementById('albums-template').innerHTML;
    const albumsTmpl = Handlebars.compile(albumsSrc);
    const albumsContainer = document.getElementById('albums');
    const addToPage = new Event('apply');

    fetch('albums.json')
      .then(res => res.json())
      .then(async res => {
        const sorted = _.sortBy(res.albums, ['date','artist']);
        checkSpotify(sorted);
      });

    document.addEventListener('apply', function(e, albums) {
      albumsContainer.innerHTML = albumsTmpl({albums: albums});
    })

    async function checkSpotify(albums) {
      let remainder = [];
      albums.forEach(async album => {
        const on_spotify = await availableOnSpotify(album);

        if (on_spotify) {
          remainder.push(Object.assign({}, album, {spotify: true}));
        } else {
          remainder.push(Object.assign({}, album, {spotify: false}));
        }
      });

      document.dispatchEvent(addToPage, remainder);

      return remainder;
    }

    function availableOnSpotify(album) {
      const query = `${album.artist} ${album.album}`;
      return fetch(`https://api.spotify.com/v1/search?q=${query}&type=album`).then(res => res.json()).then(search_results => {
        return search_results.albums.items.length > 0;
      });
    }
  </script>
</body>
</html>